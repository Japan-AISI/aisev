<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>評価結果 - AIセーフティ評価 自動レッドチーミング</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .result-card {
            margin-bottom: 20px;
            border-left: 5px solid #ddd;
        }
        .result-card.passed {
            border-left-color: #28a745;
        }
        .result-card.failed {
            border-left-color: #dc3545;
        }
        .result-card.error {
            border-left-color: #ffc107;
        }
        .result-card.skipped {
            border-left-color: #6c757d;
        }
        .prompt-text {
            font-family: monospace;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
        }
        .response-text {
            font-family: monospace;
            background-color: #f0f8ff;
            padding: 10px;
            border-radius: 5px;
        }
        .evaluation-result {
            font-weight: bold;
        }
        .passed-text {
            color: #28a745;
        }
        .failed-text {
            color: #dc3545;
        }
        .error-text {
            color: #ffc107;
        }
        .skipped-text {
            color: #6c757d;
        }
        .category-badge {
            display: inline-block;
            padding: 0.25em 0.6em;
            font-size: 0.75em;
            font-weight: 700;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.25rem;
            margin-right: 5px;
        }
        /* Japanese font settings */
        body {
            font-family: 'Noto Sans JP', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">評価結果
            {% if is_past_result %}
                <small class="text-muted">(過去の結果: {{ timestamp }})</small>
            {% endif %}
        </h1>
        
        <div class="mb-4">
            <a href="/" class="btn btn-primary me-2">ホームに戻る</a>
            <a href="/past_results" class="btn btn-secondary me-2">過去の評価結果一覧</a>
            
            <div class="btn-group">
                <button type="button" class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    エクスポート
                </button>
                <ul class="dropdown-menu">
                    {% if is_past_result %}
                        <li><a class="dropdown-item" href="/export/html/file/{{ filename }}">HTML形式でダウンロード</a></li>
                        <li><a class="dropdown-item" href="/export/csv/file/{{ filename }}">CSV形式でダウンロード</a></li>
                    {% else %}
                        <li><a class="dropdown-item" href="/export/html/{{ session_id }}">HTML形式でダウンロード</a></li>
                        <li><a class="dropdown-item" href="/export/csv/{{ session_id }}">CSV形式でダウンロード</a></li>
                    {% endif %}
                </ul>
            </div>
        </div>
        
        <!-- Evaluation summary -->
        <div class="card mb-4">
            <div class="card-header bg-dark text-white">
                <h5 class="card-title mb-0">評価サマリー</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="card text-white bg-primary mb-3">
                            <div class="card-header">テスト総数</div>
                            <div class="card-body">
                                <h5 class="card-title" id="totalTests">{{ results|length }}</h5>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-white bg-success mb-3">
                            <div class="card-header">合格</div>
                            <div class="card-body">
                                <h5 class="card-title" id="passedTests">{{ results|selectattr('evaluation.passed', 'equalto', true)|list|length }}</h5>
                                {% set not_skipped = results|rejectattr('evaluation.skipped', 'defined')|list|length %}
                                {% if not_skipped > 0 %}
                                    <p class="card-text" id="passRate">{{ (results|selectattr('evaluation.passed', 'equalto', true)|list|length / not_skipped * 100)|round(2) }}%</p>
                                {% else %}
                                    <p class="card-text" id="passRate">0%</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-white bg-danger mb-3">
                            <div class="card-header">不合格</div>
                            <div class="card-body">
                                <h5 class="card-title" id="failedTests">{{ results|selectattr('evaluation.passed', 'equalto', false)|list|length }}</h5>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-white bg-secondary mb-3">
                            <div class="card-header">スキップ</div>
                            <div class="card-body">
                                <h5 class="card-title" id="skippedTests">{{ results|selectattr('evaluation.skipped', 'defined')|list|length }}</h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Category filters -->
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="card-title mb-0">カテゴリフィルター</h5>
            </div>
            <div class="card-body">
                <div class="btn-group mb-3" role="group" id="categoryFilters">
                    <button type="button" class="btn btn-outline-primary active" data-category="all">全て</button>
                    <button type="button" class="btn btn-outline-primary" data-category="有害情報の出力制御">有害情報の出力制御</button>
                    <button type="button" class="btn btn-outline-primary" data-category="偽誤情報の出力・誘導の防止">偽誤情報の出力・誘導の防止</button>
                    <button type="button" class="btn btn-outline-primary" data-category="公平性と包摂性">公平性と包摂性</button>
                    <button type="button" class="btn btn-outline-primary" data-category="ハイリスク利用・目的外利用への対処">ハイリスク利用・目的外利用への対処</button>
                    <button type="button" class="btn btn-outline-primary" data-category="プライバシー保護">プライバシー保護</button>
                </div>
                <div class="btn-group" role="group" id="statusFilters">
                    <button type="button" class="btn btn-outline-secondary active" data-status="all">全てのステータス</button>
                    <button type="button" class="btn btn-outline-success" data-status="passed">合格</button>
                    <button type="button" class="btn btn-outline-danger" data-status="failed">不合格</button>
                    <button type="button" class="btn btn-outline-secondary" data-status="skipped">スキップ</button>
                </div>
            </div>
        </div>
        
        <!-- Evaluation results list -->
        <div id="resultsList">
            {% for result in results %}
                {% set status_class = 'skipped' if result.evaluation.skipped else 'passed' if result.evaluation.passed else 'failed' %}
                {% set status_text = 'skipped' if result.evaluation.skipped else 'passed' if result.evaluation.passed else 'failed' %}
                <div class="card result-card {{ status_class }}" data-category="{{ result.category }}" data-status="{{ status_text }}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>
                            <span class="category-badge bg-info">{{ result.category }}</span>
                            <span class="evaluation-result {{ status_class }}-text">
                                {% if result.evaluation.skipped %}
                                    ⏭️ スキップ
                                {% elif result.evaluation.passed %}
                                    ✅ 合格
                                {% else %}
                                    ❌ 不合格
                                {% endif %}
                            </span>
                        </span>
                        <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}">
                            詳細
                        </button>
                    </div>
                    <div class="card-body">
                        <h5 class="card-title">要件: {{ result.requirement }}</h5>
                        <div class="collapse" id="collapse{{ loop.index }}">
                            <div class="card-text mt-3">
                                <div class="mb-3">
                                    <h6>敵対的プロンプト:</h6>
                                    <div class="prompt-text">{{ result.prompt }}</div>
                                </div>
                                <div class="mb-3">
                                    <h6>ターゲットAIの応答:</h6>
                                    <div class="response-text">{{ result.target_response }}</div>
                                </div>
                                <div>
                                    <h6>評価理由:</h6>
                                    <p>{{ result.evaluation.reason }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Category filter
            const categoryButtons = document.querySelectorAll('#categoryFilters button');
            categoryButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Toggle active class
                    categoryButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    const category = this.getAttribute('data-category');
                    filterResults();
                });
            });
            
            // Status filter
            const statusButtons = document.querySelectorAll('#statusFilters button');
            statusButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Toggle active class
                    statusButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    filterResults();
                });
            });
            
            function filterResults() {
                const selectedCategory = document.querySelector('#categoryFilters button.active').getAttribute('data-category');
                const selectedStatus = document.querySelector('#statusFilters button.active').getAttribute('data-status');
                
                const resultCards = document.querySelectorAll('.result-card');
                resultCards.forEach(card => {
                    const cardCategory = card.getAttribute('data-category');
                    const cardStatus = card.getAttribute('data-status');
                    
                    const categoryMatch = selectedCategory === 'all' || cardCategory === selectedCategory;
                    const statusMatch = selectedStatus === 'all' || cardStatus === selectedStatus;
                    
                    if (categoryMatch && statusMatch) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            }
        });
    </script>
</body>
</html>